# MySQL Import Guide

This guide explains how to import the CSV files generated by the WOS XML Parser into a MySQL database.

## Prerequisites

1. **MySQL Server**: You need a running MySQL server (version 5.7 or higher recommended)
2. **Python Package**: Install the `pymysql` package:
   ```bash
   pip install pymysql
   ```

## Quick Start

### 1. Generate CSV Files

First, run the XML parser to generate CSV files:

```bash
cd for_xml
python xml_proc_main.py path/to/xml/files/
```

This will create 33 CSV files in the `xml_output` directory.

### 2. Import to MySQL

Run the import script with default settings:

```bash
python import_to_mysql.py
```

This will:
- Connect to MySQL at `localhost` with user `root` and empty password
- Create a database named `wos_xml`
- Create 33 tables with proper schema
- Import all CSV files into their respective tables

## Advanced Usage

### Custom Database Configuration

Specify custom MySQL connection parameters:

```bash
python import_to_mysql.py --host localhost --user myuser --password mypass --database my_wos_db
```

### Custom CSV Directory

If your CSV files are in a different location:

```bash
python import_to_mysql.py --csv-dir /path/to/csv/files
```

### Drop and Recreate Database

**WARNING**: This will delete all existing data in the database!

```bash
python import_to_mysql.py --drop-existing
```

### Complete Example

```bash
python import_to_mysql.py \
    --host localhost \
    --user root \
    --password mypassword \
    --database wos_xml \
    --csv-dir xml_output \
    --drop-existing
```

## Command-Line Options

| Option | Description | Default |
|--------|-------------|---------|
| `--host` | MySQL server hostname | localhost |
| `--user` | MySQL username | root |
| `--password` | MySQL password | (empty) |
| `--database` | Database name | wos_xml |
| `--csv-dir` | Directory containing CSV files | xml_output |
| `--drop-existing` | Drop existing database before import | False |

## Database Schema

The script creates 33 tables organized into 6 sections:

### Section 1: Paper Basic Information (14 tables)
- `item` - Main paper metadata (PRIMARY KEY: uid)
- `item_title` - Paper titles
- `item_abstract` - Paper abstracts
- `item_doc_types` - Document types
- `item_doc_types_norm` - Normalized document types
- `item_langs` - Languages
- `item_langs_norm` - Normalized languages
- `item_editions` - WOS editions
- `item_keywords` - Keywords
- `item_keywords_plus` - Keywords Plus
- `item_source` - Source publication information
- `item_ids` - Identifiers (DOI, ISSN, etc.)
- `item_oas` - Open access information
- `item_publishers` - Publisher information

### Section 2: Author Information (12 tables)
- `item_authors` - Author names and details
- `item_addresses` - Author addresses
- `item_au_addrs` - Author-address relationships
- `item_addr_aus` - Address-author relationships
- `item_orgs` - Organizations
- `item_suborgs` - Sub-organizations
- `item_author_ids` - Author identifiers (ORCID, ResearcherID)
- `item_rp_addrs` - Reprint addresses
- `item_rp_au_addrs` - Reprint author-address relationships
- `item_rp_orgs` - Reprint organizations
- `item_rp_suborgs` - Reprint sub-organizations
- `item_contributors` - Contributors with IDs

### Section 3: Category Information (2 tables)
- `item_headings` - Research headings
- `item_subjects` - Research subjects

### Section 4: References (2 tables)
- `item_references` - Cited references
- `item_cite_locations` - Citation locations in text

### Section 5: Funding Information (2 tables)
- `item_acks` - Acknowledgments
- `item_grants` - Grant information

### Section 6: Conference Information (1 table)
- `item_conferences` - Conference details

## Table Relationships

- All tables (except `item`) have a foreign key reference to `item(uid)`
- Foreign keys are set with `ON DELETE CASCADE` for data integrity
- The `item` table must be populated first
- Appropriate indexes are created for common query patterns

## Performance Notes

- The import uses batch processing (1000 rows per batch) for better performance
- Foreign key checks are temporarily disabled during table creation
- Full-text indexes are created on `abstract` and `ack_text` fields for text search
- Appropriate indexes are created on commonly queried fields (uid, year, country, etc.)

## Character Encoding

- Database uses `utf8mb4` character set with `utf8mb4_unicode_ci` collation
- This supports full Unicode including emojis and special characters
- Proper handling of international author names and publication titles

## Troubleshooting

### Connection Issues

If you get connection errors:
```bash
# Check if MySQL is running
sudo systemctl status mysql

# Verify credentials
mysql -u root -p
```

### Permission Issues

If you get permission errors, grant necessary privileges:
```sql
GRANT ALL PRIVILEGES ON wos_xml.* TO 'username'@'localhost';
FLUSH PRIVILEGES;
```

### Import Errors

Check the error summary at the end of the import. Common issues:
- Missing CSV files: Make sure you ran the XML parser first
- Data type mismatches: Check if CSV data matches expected schema
- Foreign key violations: The script handles this by importing in correct order

### Large Datasets

For very large datasets:
- Consider increasing MySQL's `max_allowed_packet` setting
- Monitor disk space during import
- The script shows progress for each table

## Querying the Database

After import, you can query the database:

```sql
USE wos_xml;

-- Count total papers
SELECT COUNT(*) FROM item;

-- Papers by year
SELECT pubyear, COUNT(*) as count 
FROM item 
GROUP BY pubyear 
ORDER BY pubyear DESC;

-- Top authors
SELECT full_name, COUNT(*) as papers 
FROM item_authors 
GROUP BY full_name 
ORDER BY papers DESC 
LIMIT 10;

-- Papers with abstracts
SELECT i.uid, i.pubyear, t.title, a.abstract 
FROM item i 
JOIN item_title t ON i.uid = t.uid 
JOIN item_abstract a ON i.uid = a.uid 
LIMIT 10;
```

## Security Considerations

1. **Passwords**: Don't use `--password` on command line in production. Instead:
   - Use a configuration file with restricted permissions
   - Use environment variables
   - Prompt for password interactively

2. **Database Access**: Create a dedicated MySQL user with minimal privileges:
   ```sql
   CREATE USER 'wos_importer'@'localhost' IDENTIFIED BY 'secure_password';
   GRANT SELECT, INSERT, CREATE, DROP ON wos_xml.* TO 'wos_importer'@'localhost';
   ```

3. **Drop Existing**: Use `--drop-existing` carefully as it permanently deletes data

## Support

For issues or questions:
- Check the main README.md in the for_xml directory
- Review the tables.md file for detailed schema documentation
- Check MySQL error logs: `/var/log/mysql/error.log`
