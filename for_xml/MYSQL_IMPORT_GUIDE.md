# MySQL/MariaDB Import Guide

This guide explains how to import the CSV files generated by the WOS XML Parser into a MySQL or MariaDB database.

## Prerequisites

1. **Database Server**: You need a running MySQL (version 5.7+) or MariaDB (version 10.3+) server
   - **Linux Debian users**: MariaDB is the default SQL server and is fully supported
   - **Other Linux distributions**: Both MySQL and MariaDB are supported
   
2. **Python Package**: Install the `pymysql` package (works with both MySQL and MariaDB):
   ```bash
   pip install pymysql
   ```
   
   Alternatively, you can use `mysqlclient` which has better native MariaDB support on Linux:
   ```bash
   pip install mysqlclient
   ```
   
   The import script automatically detects and works with either library.

## Quick Start

### 1. Generate CSV Files

First, run the XML parser to generate CSV files:

```bash
cd for_xml
python xml_proc_main.py path/to/xml/files/
```

This will create 33 CSV files in the `xml_output` directory.

### 2. Import to MySQL/MariaDB

Run the import script with default settings:

```bash
python import_to_mysql.py
```

This will:
- Connect to MySQL/MariaDB at `localhost` with user `root` and empty password
- Automatically detect whether you're using MySQL or MariaDB
- Create a database named `wos_xml`
- Create 33 tables with proper schema
- Import all CSV files into their respective tables

## Advanced Usage

### Custom Database Configuration

Specify custom connection parameters:

```bash
python import_to_mysql.py --host localhost --user myuser --password mypass --database my_wos_db
```

### Custom CSV Directory

If your CSV files are in a different location:

```bash
python import_to_mysql.py --csv-dir /path/to/csv/files
```

### Drop and Recreate Database

**WARNING**: This will delete all existing data in the database!

```bash
python import_to_mysql.py --drop-existing
```

### Complete Example

```bash
python import_to_mysql.py \
    --host localhost \
    --user root \
    --password mypassword \
    --database wos_xml \
    --csv-dir xml_output \
    --drop-existing
```

## Command-Line Options

| Option | Description | Default |
|--------|-------------|---------|
| `--host` | MySQL/MariaDB server hostname | localhost |
| `--user` | MySQL/MariaDB username | root |
| `--password` | MySQL/MariaDB password | (empty) |
| `--database` | Database name | wos_xml |
| `--csv-dir` | Directory containing CSV files | xml_output |
| `--drop-existing` | Drop existing database before import | False |

## Database Schema

The script creates 33 tables organized into 6 sections:

### Section 1: Paper Basic Information (14 tables)
- `item` - Main paper metadata (PRIMARY KEY: uid)
- `item_title` - Paper titles
- `item_abstract` - Paper abstracts
- `item_doc_types` - Document types
- `item_doc_types_norm` - Normalized document types
- `item_langs` - Languages
- `item_langs_norm` - Normalized languages
- `item_editions` - WOS editions
- `item_keywords` - Keywords
- `item_keywords_plus` - Keywords Plus
- `item_source` - Source publication information
- `item_ids` - Identifiers (DOI, ISSN, etc.)
- `item_oas` - Open access information
- `item_publishers` - Publisher information

### Section 2: Author Information (12 tables)
- `item_authors` - Author names and details
- `item_addresses` - Author addresses
- `item_au_addrs` - Author-address relationships
- `item_addr_aus` - Address-author relationships
- `item_orgs` - Organizations
- `item_suborgs` - Sub-organizations
- `item_author_ids` - Author identifiers (ORCID, ResearcherID)
- `item_rp_addrs` - Reprint addresses
- `item_rp_au_addrs` - Reprint author-address relationships
- `item_rp_orgs` - Reprint organizations
- `item_rp_suborgs` - Reprint sub-organizations
- `item_contributors` - Contributors with IDs

### Section 3: Category Information (2 tables)
- `item_headings` - Research headings
- `item_subjects` - Research subjects

### Section 4: References (2 tables)
- `item_references` - Cited references
- `item_cite_locations` - Citation locations in text

### Section 5: Funding Information (2 tables)
- `item_acks` - Acknowledgments
- `item_grants` - Grant information

### Section 6: Conference Information (1 table)
- `item_conferences` - Conference details

## Table Relationships

- All tables (except `item`) have a foreign key reference to `item(uid)`
- Foreign keys are set with `ON DELETE CASCADE` for data integrity
- The `item` table must be populated first
- Appropriate indexes are created for common query patterns

## Performance Notes

- The import uses batch processing (1000 rows per batch) for better performance
- Foreign key checks are temporarily disabled during table creation
- Full-text indexes are created on `abstract` and `ack_text` fields for text search
- Appropriate indexes are created on commonly queried fields (uid, year, country, etc.)

## Character Encoding

- Database uses `utf8mb4` character set with `utf8mb4_unicode_ci` collation
- This supports full Unicode including emojis and special characters
- Proper handling of international author names and publication titles

## Troubleshooting

### Connection Issues

If you get connection errors:

**For MySQL:**
```bash
# Check if MySQL is running
sudo systemctl status mysql

# Verify credentials
mysql -u root -p
```

**For MariaDB (Debian/Ubuntu default):**
```bash
# Check if MariaDB is running
sudo systemctl status mariadb

# Verify credentials
mariadb -u root -p
# OR
mysql -u root -p  # mysql command works with MariaDB too
```

### Permission Issues

If you get permission errors, grant necessary privileges:

**For MySQL:**
```sql
GRANT ALL PRIVILEGES ON wos_xml.* TO 'username'@'localhost';
FLUSH PRIVILEGES;
```

**For MariaDB:**
```sql
-- Same syntax works for MariaDB
GRANT ALL PRIVILEGES ON wos_xml.* TO 'username'@'localhost';
FLUSH PRIVILEGES;
```

### MariaDB-Specific Notes

1. **Default Authentication**: On Debian/Ubuntu, MariaDB may use unix_socket authentication for root:
   ```bash
   # Connect as root without password (if using unix_socket)
   sudo mariadb
   
   # Create a user with password authentication
   CREATE USER 'wos_user'@'localhost' IDENTIFIED BY 'password';
   GRANT ALL PRIVILEGES ON wos_xml.* TO 'wos_user'@'localhost';
   FLUSH PRIVILEGES;
   ```

2. **Compatibility**: The import script automatically detects and works with both MySQL and MariaDB
   - MariaDB is a drop-in replacement for MySQL
   - All SQL syntax used is compatible with both systems
   - The script will display which database type it detected upon connection

### Import Errors

Check the error summary at the end of the import. Common issues:
- Missing CSV files: Make sure you ran the XML parser first
- Data type mismatches: Check if CSV data matches expected schema
- Foreign key violations: The script handles this by importing in correct order

### Large Datasets

For very large datasets:
- Consider increasing MySQL/MariaDB's `max_allowed_packet` setting
- Monitor disk space during import
- The script shows progress for each table

**MySQL configuration:**
```ini
# /etc/mysql/my.cnf or /etc/mysql/mysql.conf.d/mysqld.cnf
[mysqld]
max_allowed_packet=256M
```

**MariaDB configuration:**
```ini
# /etc/mysql/mariadb.conf.d/50-server.cnf
[mysqld]
max_allowed_packet=256M
```

## Querying the Database

After import, you can query the database:

```sql
USE wos_xml;

-- Count total papers
SELECT COUNT(*) FROM item;

-- Papers by year
SELECT pubyear, COUNT(*) as count 
FROM item 
GROUP BY pubyear 
ORDER BY pubyear DESC;

-- Top authors
SELECT full_name, COUNT(*) as papers 
FROM item_authors 
GROUP BY full_name 
ORDER BY papers DESC 
LIMIT 10;

-- Papers with abstracts
SELECT i.uid, i.pubyear, t.title, a.abstract 
FROM item i 
JOIN item_title t ON i.uid = t.uid 
JOIN item_abstract a ON i.uid = a.uid 
LIMIT 10;
```

### Running Example Queries

A comprehensive set of example queries is provided in `example_queries.py`:

```bash
python example_queries.py
```

This script demonstrates 15+ common queries including:
- Paper counts by year, country, organization
- Author and citation statistics
- Research subject analysis
- Funding and grant information
- Open access statistics

You can use these as templates for your own analysis.

## Security Considerations

1. **Passwords**: Don't use `--password` on command line in production. Instead:
   - Use a configuration file with restricted permissions
   - Use environment variables
   - Prompt for password interactively

2. **Database Access**: Create a dedicated database user with minimal privileges:
   
   **For MySQL:**
   ```sql
   CREATE USER 'wos_importer'@'localhost' IDENTIFIED BY 'secure_password';
   GRANT SELECT, INSERT, CREATE, DROP ON wos_xml.* TO 'wos_importer'@'localhost';
   ```
   
   **For MariaDB:**
   ```sql
   -- Same syntax works for MariaDB
   CREATE USER 'wos_importer'@'localhost' IDENTIFIED BY 'secure_password';
   GRANT SELECT, INSERT, CREATE, DROP ON wos_xml.* TO 'wos_importer'@'localhost';
   ```

3. **Drop Existing**: Use `--drop-existing` carefully as it permanently deletes data

## Support

For issues or questions:
- Check the main README.md in the for_xml directory
- Review the tables.md file for detailed schema documentation
- Check database error logs:
  - MySQL: `/var/log/mysql/error.log`
  - MariaDB: `/var/log/mysql/error.log` or `/var/log/mariadb/mariadb.log`

## Compatibility Notes

The import script is fully compatible with both MySQL and MariaDB:
- **Tested with**: MySQL 5.7+, MySQL 8.0+, MariaDB 10.3+, MariaDB 10.5+, MariaDB 10.11+
- **Character encoding**: utf8mb4 with unicode collation (supports all international characters)
- **SQL syntax**: Uses standard SQL compatible with both database systems
- **Auto-detection**: Script automatically detects which database server you're using
- **Libraries**: Works with both `pymysql` and `mysqlclient` Python packages
